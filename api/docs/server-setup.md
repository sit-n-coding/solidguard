<div align="center">
  <p align="center">
    <img src="img/solidguard-prototype-v1-2.png" width="200" alt="SolidGuard Logo" />
  </p>
<h1>Server Setup for solidguard-backend</h1>
</div>

**Version:** `prototype-v1.2`

## Table of Contents
- [Table of Contents](#table-of-contents)
- [Setup](#setup)
  - [1. Install Databases](#1-install-databases)
  - [2. Environment Variables Setup](#2-environment-variables-setup)
    - [Prisma + PostgreSQL](#prisma--postgresql)
    - [Redis](#redis)
    - [Nest.js](#nestjs)
    - [Smart Contracts](#smart-contracts)
    - [Security](#security)
    - [Emails](#emails)
    - [Initial Admin Account](#initial-admin-account)
  - [3. Install dependencies](#3-install-dependencies)
  - [4. Smart Contract Setup](#4-smart-contract-setup)
  - [5. Prisma Setup](#5-prisma-setup)
  - [6. Start NestJS Server](#6-start-nestjs-server)
  - [7. Deploying with Docker](#7-deploying-with-docker)

## Setup

**Note:** For local deployment, follow steps 1-6, and for docker deployment, follow steps 2-4, and step 7.

### 1. Install Databases

Before we proceed, you will need to install PostgreSQL and Redis on your computer, and set up a user with read/write permissions to the database.

There are many ways to install these databases, so I have linked the ones that my colleagues and I have used:
* PostgreSQL (OSX) https://dyclassroom.com/howto-mac/how-to-install-postgresql-on-mac-using-homebrew
* Redis (OSX) https://gist.github.com/tomysmile/1b8a321e7c58499ef9f9441b2faa0aa8
* Redis (Windows) https://stackoverflow.com/questions/6476945/how-do-i-run-redis-on-windows?rq=1


Once you have installed your databases, you will need to access PostgreSQL and run a command that will create a user with read/write access. To create a user for this server, you will need to run the SQL command (works with PostgreSQL 8.1 and above):
```sql
CREATE ROLE rolename LOGIN SUPERUSER WITH PASSWORD 'password'
```
You can customize this command however you'd like, see [this link](https://www.postgresql.org/docs/8.0/sql-createuser.html) for more information.

### 2. Environment Variables Setup
Fill in the following environment variables in a new file called `.env`:
#### Prisma + PostgreSQL
* `DATABASE_URL` The database connection URL to the PostgreSQL database.
  * **Note:** 
    * For the `DATABASE_HOST` in the URL and in the env variable, it should be `localhost` when deploying locally, or `postgres` when deploying with `docker-compose`.
    * `POSTGRES_PASSWORD` must be in the `.env` file when using `docker-compose`.

#### Redis
* `REDIS_HOST` Host for the redis database. Use `localhost` when deploying locally, or `redis` when deploying with `docker-compose`.
* `REDIS_PORT` Port for the redis database.

#### Nest.js
* `PORT` Port of the Nest.js server.

#### Smart Contracts
* `PROVIDER_URL` Provider URL for EVM-compatible blockchains. You can get a provider URL via [Infura](https://infura.io/).
* `DEPLOY_PRIVATE_KEY` Private key used for deployment of smart contracts and tests that uses third-party APIs. You can generate one via [vanity.eth](https://vanity-eth.tk/). It is important that the account associated with this private key is owner of the SolidGuardManager at the address `SGM_ADDRESS`. Please do note that you will need some Ether since this key will be what's deploying the SolidGuardManager.
* `ETHERSCAN_API_KEY` [Etherscan](https://etherscan.io/) API Key. Can be generated by signing up on their website.
* `ETHERSCAN_URL` Base URL used to fetch information from Etherscan. This needs to correspond to the same blockchain provided in `PROVIDER_URL`.
* `SGM_ADDRESS` SolidGuardManager Smart Contract address on any of the EVM-Compatible blockchains. It should correspond to the same blockchain provided in `PROVIDER_URL`, and will be filled in during the smart contract setup.

#### Security
* `JWT_ACCESS_SECRET` [Passport-jwt](http://www.passportjs.org/packages/passport-jwt/) A string containing the secret for verifying the JSON web token's signature.
* `JWT_EXPIRES_TIME`  A string describing a time span as the expire time of a JSON web token, defined for JwtModule.

#### Emails
* `TRANS_HOST` The host name for the email notification service. Should be "smtp.ethereal.email" by default
* `TRANS_PORT` The port number for email notification service. Should be 587 by default.
* `EMAIL_USER` The user name account for SolidGuard service. e.g. solidguard@gmail.com. It can be undefined if using a temporary test account.
* `EMAIL_PASSWORD` The actual password for the above email account. It can be undefined if using a temporary test account.
* `EMAIL_SERVICE` The service that used for the email account. e.g. 'gmail', 'hotmail'. It can be undefined if using a temporary test account.

#### Initial Admin Account
* `ADMIN_EMAIL` The email of the admin account created on server startup.
* `ADMIN_PASSWORD` The password of the admin account created on server startup.

Examples of these variables can be seen in [`.env.example`](../.env.example).

### 3. Install dependencies

Install the dependencies for the Nest application:

```bash
npm install
```

After all dependencies have been installed, it will automatically run `npm run prisma:generate`, which will generate all the entity types used in the server.

### 4. Smart Contract Setup

First, you will need to run 
```bash
npx hardhat run --network providerNetwork deploy/main/solid-guard-manager.deploy.ts
```
to deploy a new SolidGuardManager under the ownership of the deployer account.

You will see an address appear in the console. Copy it and save it in the `.env` file as `SGM_ADDRESS`.

Next, you will need to verify the smart contract on etherscan by doing 
```bash
npx hardhat verify --network providerNetwork SGM_ADDRESS
```
with `SGM_ADDRESS` being the addressed printed from earlier.

If you want to deploy other smart contracts to test the pauseability, see [dapp-setup.md](dapp-setup.md) on how to do this.


### 5. Prisma Setup

To setup Prisma, you will need to run 

```bash
npm run migrate:dev
```

to migrate the schemas used in the PostgreSQL database.

### 6. Start NestJS Server

Run Nest Server in Development mode:

```bash
npm start

# watch mode
npm run start:dev
```
Now your server should be up! For instructions on using the APIs, see `/api/` for the Swagger documentation.

### 7. Deploying with Docker

Run docker-compose to run the databases and backend api, all in one command.
```bash
docker-compose up --build -d
```

[Back to top](#table-of-contents)
